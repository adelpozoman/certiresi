<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">


<!--    <script src="qr-scanner.umd.min.js"></script>-->

    <script>
        function submitForm(city, code) {
            let data = {
                city: city,
                code: code
            };

            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/submit', true);
            xhr.setRequestHeader('Content-Type', 'application/json'); // Set the content type to JSON
            xhr.onload = function() {
                if (xhr.status >= 200 && xhr.status < 300) {
                    var responseData = JSON.parse(xhr.responseText);
                    // Update page based on response
                    //document.getElementById('result').innerText = responseData.message;
                    console.log(responseData);


                    showResponse(responseData);

                    //5 seconds timer:
                    setTimeout(function() {
                        // Execute second instruction after 5 seconds
                        console.log("Second instruction");
                        fillMasterWithCommunityCards();
                    }, 5000);



                    //return responseData;
                } else {
                    console.error('Request failed with status code ' + xhr.status);
                }
            };
            xhr.onerror = function() {
                console.error('Request failed');
            };

            // Convert the data object to JSON and send it in the request body
            xhr.send(JSON.stringify(data));

            showWaiting();
        }


    </script>




<script>
        //open phone camera
    function camera() {
        // Get the video element
        var video = document.createElement('video');
        video.setAttribute('autoplay', '');
        video.setAttribute('playsinline', '');

        // Get user media
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(function(stream) {
                video.srcObject = stream;
            })
            .catch(function(error) {
                console.error('getUserMedia error:', error);
            });

        // Replace the futureCamera div with the video element
        var futureCameraDiv = document.getElementById('futureCamera');
        futureCameraDiv.replaceWith(video);



        import('/qr-scanner.min.js').then((module) => {
            const QrScanner = module.default;
            // do something with QrScanner
            const qrScanner = new QrScanner(
                video,
                result => {
                    console.log('decoded qr code:', result);
                    qrScanner.stop();
                    //destroy futureCameraDiv
                    futureCameraDiv.remove();
                    submitForm("santJoan", result.data);
                },
                { /* your options or returnDetailedScanResult: true if you're not specifying any other options */ },
            );
            qrScanner.start();


        });





    }


</script>



<!--    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>-->
    <script src="/html5-qrcode.min.js" type="text/javascript"></script>

    <script>

    async function camera2(city) {
        clearMasterChildren();
        var backCamera = document.createElement('div');
        backCamera.setAttribute('id', 'backCamera');
        document.getElementById('master').appendChild(backCamera);
        
        // This method will trigger user permissions
        Html5Qrcode.getCameras().then(devices => {
            /**
             * devices would be an array of objects of type:
             * { id: "id", label: "label" }
             */
            console.log(devices);
            if (devices && devices.length) {
                var cameraId = devices[0].id;
                // .. use this to start scanning.
                const html5QrCode = new Html5Qrcode(/* element id */ "backCamera", /* verbose= */ false);
                html5QrCode.start(
                    cameraId,
                    {
                        fps: 10,    // Optional, frame per seconds for qr code scanning
                        //qrbox: { width: 250, height: 250 }  // Optional, if you want bounded box UI
                    },
                    (decodedText, decodedResult) => {
                        // do something when code is read
                        console.log("decodedText", decodedText);
                        //console.log("decodedResult", decodedResult);

                        html5QrCode.stop().then(ignore => {
                            // QR Code scanning is stopped.
                        }).catch(err => {
                            // Stop failed, handle it.
                        });
                        clearMasterChildren();
                        submitForm(city, decodedText);
                    },
                    (errorMessage) => {
                        // parse error, ignore it.
                        console.log("errorMessage", errorMessage);
                    })
                    .catch((err) => {
                        // Start failed, handle it.
                    });


            }
        }).catch(err => {
            // handle err
        });

    }
    </script>


    <script>
        function clearMasterChildren() {
            var master = document.getElementById('master');
            while (master.firstChild) {
                master.removeChild(master.firstChild);
            }
        }
    </script>

    <script>
        function showBaleares(){
            clearMasterChildren();
            var futureCamera = document.createElement('div');
            futureCamera.setAttribute('class', 'card w-100 h-25 text-center border rounded');
            futureCamera.setAttribute('id', 'futureCamera');
            futureCamera.setAttribute('onclick', 'camera2("santaeulalia")');
            futureCamera.innerHTML = '<div class="card-body"><h5 class="card-title">Santa Eulalia</h5><p class="card-text">With supporting text below as a natural lead-in to additional content.</p><a href="#" class="btn btn-primary">Go somewhere</a></div>';
            document.getElementById('master').appendChild(futureCamera);

            var futureCamera2 = document.createElement('div');
            futureCamera2.setAttribute('class', 'card w-100 h-25 text-center border rounded');
            futureCamera2.setAttribute('id', 'futureCamera2');
            futureCamera2.setAttribute('onclick', 'camera2("palma")');
            futureCamera2.innerHTML = '<div class="card-body"><h5 class="card-title">Palma</h5><p class="card-text">With supporting text below as a natural lead-in to additional content.</p><a href="#" class="btn btn-primary">Go somewhere</a></div>';
            document.getElementById('master').appendChild(futureCamera2);

            var futureCamera3 = document.createElement('div');
            futureCamera3.setAttribute('class', 'card w-100 h-25 text-center border rounded');
            futureCamera3.setAttribute('id', 'futureCamera3');
            futureCamera3.setAttribute('onclick', 'camera2("santjosep")');
            futureCamera3.innerHTML = '<div class="card-body"><h5 class="card-title">Sant Josep de Sa Talaia</h5><p class="card-text">With supporting text below as a natural lead-in to additional content.</p><a href="#" class="btn btn-primary">Go somewhere</a></div>';
            document.getElementById('master').appendChild(futureCamera3);



        }
    </script>


    <script>
        function fillMasterWithCommunityCards(){
            document.getElementById("master").innerHTML ='<div class="card w-100 h-50 text-center border rounded" style=";" id="futureCamera2" onclick="showBaleares()">\n' +
                '        <div class="card-body">\n' +
                '            <h5 class="card-title">Illes Balears</h5>\n' +
                '            <p class="card-text">Reconoce certificados de santaEulalia, palma, santjosep, santjoan, ibiza y alaior.</p>\n' +
                '            <a href="#" class="btn btn-primary">Go somewhere</a>\n' +
                '        </div>\n' +
                '    </div>\n' +
                '    <div class="card w-100 h-50 text-center border rounded" style=";" id="futureCamera" onclick="camera()">\n' +
                '        <div class="card-body">\n' +
                '            <h5 class="card-title">Illes Canarias</h5>\n' +
                '            <p class="card-text">Reconocerá Santa Cruz de Tenerife</p>\n' +
                '            <a href="#" class="btn btn-primary">Go somewhere</a>\n' +
                '        </div>';
        }
    </script>


    <script>
        function showWaiting(){
            document.getElementById("master").innerHTML = '<div class="container">\n' +
                '    <div class="row">\n' +
                '      <div class="col-md-12 text-center">\n' +
                '        <h1 class="mt-5">Waiting Response</h1>\n' +
                '      </div>\n' +
                '    </div>\n' +
                '  </div>'
            return;
        }
    </script>

    <script>
        function showResponse(data){
            document.getElementById("master").innerHTML = '<div class="container">\n' +
                '    <div class="row">\n' +
                '      <div class="col-md-12">\n' +
                '        <h1 class="mt-5">Information</h1>\n' +
                '        <div class="mt-4">\n' +
                '          <p>ID: <span id="idvariable">'+ data.id +'</span></p>\n' +
                '          <p>NAME: <span id="namevariable">'+ data.name +'</span></p>\n' +
                '          <p>DATE: <span id="datevariable">'+ data.date +'</span></p>\n' +
                '        </div>\n' +
                '      </div>\n' +
                '    </div>\n' +
                '  </div>'

        }
    </script>





</head>
<body>

<div id="master" style="height: 100vh; background-color: rgba(255,0,0,0.1);">
    <div class="card w-100 h-50 text-center border rounded" style=";" id="futureCamera2" onclick="showBaleares()">
        <div class="card-body">
            <h5 class="card-title">Illes Balears</h5>
            <p class="card-text">Reconoce certificados de santaEulalia, palma, santjosep, santjoan, ibiza y alaior.</p>
            <a href="#" class="btn btn-primary">Go somewhere</a>
        </div>
    </div>
    <div class="card w-100 h-50 text-center border rounded" style=";" id="futureCamera" onclick="camera()">
        <div class="card-body">
            <h5 class="card-title">Illes Canarias</h5>
            <p class="card-text">Reconocerá Santa Cruz de Tenerife</p>
            <a href="#" class="btn btn-primary">Go somewhere</a>
        </div>
    </div>


</div>




<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>